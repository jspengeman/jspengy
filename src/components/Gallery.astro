---
import { Picture } from "astro:assets";
import { getAllImages } from "../utils/gallery";
import "photoswipe/style.css";

const images = await getAllImages();
const THUMBNAIL_QUALITY = 20;
---

<div class="my-2 mb-8" transition:animate="fade">
    <div
        id="photo-gallery"
        class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-x-4"
    >
        {
            images.map((image) => (
                <div>
                    <a
                        href={`/gallery/${image.fileName}`}
                        data-astro-prefetch="hover"
                        data-pswp-srcset={image.attributes.hqsrcset}
                        data-pswp-width={image.attributes.width}
                        data-pswp-height={image.attributes.height}
                    >
                        <Picture
                            src={image.src}
                            alt="Sorry, I will work on getting alt text implemented. One step at a time."
                            class="mb-4 h-auto max-w-full rounded-sm"
                            decoding="sync"
                            loading={image.attributes.loading}
                            height={image.attributes.height}
                            width={image.attributes.width}
                            quality={THUMBNAIL_QUALITY}
                            style={image.attributes.style}
                            widths={[320, 480, 640, 768]}
                            sizes="(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw"
                        />
                    </a>
                </div>
            ))
        }
    </div>
</div>

<script>
    import PhotoSwipeLightbox from "photoswipe/lightbox";
    const gallery = document.getElementById("photo-gallery");
    const shouldRegister = () => gallery !== undefined;

    const registerScript = () => {
        const lightbox = new PhotoSwipeLightbox({
            gallery: "#photo-gallery",
            children: "a",
            pswpModule: () => import("photoswipe"),
        });

        lightbox.init();

        lightbox.on("contentActivate", ({ content }) => {
            const element = content.data.element as
                | HTMLAnchorElement
                | undefined;
            window.history.replaceState(null, "", element?.href);
        });

        lightbox.on("close", () => {
            window.history.replaceState(null, "", "/");
        });
    };

    if (shouldRegister()) {
        registerScript();

        // Note: We run this JS on every page load. View transistions cause the JS to not load normally.
        // Github Issue: https://github.com/withastro/astro/issues/7765#issuecomment-2155408334
        document.addEventListener("astro:after-swap", registerScript);
    }
</script>
